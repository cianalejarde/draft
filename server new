const TEXTBEE_CONFIG = {
  apiKey: process.env.TEXTBEE_API_KEY,
  deviceId: process.env.TEXTBEE_DEVICE_ID,
  apiUrl: 'https://api.textbee.dev/api/v1'
};

const sendSMSOTP = async (phoneNumber, otp, patientName) => {
  try {
    if (!isSMSConfigured) {
      throw new Error('SMS service not configured. Please contact administrator.');
    }
    
    console.log('üì± Starting SMS send process...');
    console.log('   Original phone number:', phoneNumber);
    
    let formattedPhone = phoneNumber.toString().trim();
    
    // Convert Philippine numbers to international format (+639XXXXXXXXX)
    // Your database stores numbers as: 09123456789
    // TextBee needs: +639123456789
    if (formattedPhone.startsWith('09')) {
      // 09123456789 -> +639123456789
      formattedPhone = '+63' + formattedPhone.substring(1);
    } else if (formattedPhone.startsWith('639')) {
      // 639123456789 -> +639123456789
      formattedPhone = '+' + formattedPhone;
    } else if (formattedPhone.startsWith('+639')) {
      // Already in correct format
      formattedPhone = formattedPhone;
    } else if (formattedPhone.startsWith('63')) {
      // 63123456789 -> +639123456789
      formattedPhone = '+' + formattedPhone;
    }
    
    console.log('   Formatted phone number:', formattedPhone);
    
    // Validate Philippine number format
    if (!/^\+639\d{9}$/.test(formattedPhone)) {
      console.error('‚ùå Invalid phone format:', formattedPhone);
      throw new Error('Invalid Philippine mobile number format');
    }
    
    const message = `CLICARE: Your verification code is ${otp}. Valid for 5 minutes. Do not share this code.`;
    
    console.log('   Sending to TextBee API...');
    console.log('   Device ID:', TEXTBEE_CONFIG.deviceId);
    console.log('   API URL:', `${TEXTBEE_CONFIG.apiUrl}/gateway/devices/${TEXTBEE_CONFIG.deviceId}/send-sms`);
    
    // Send SMS using TextBee API
    const response = await axios.post(
      `${TEXTBEE_CONFIG.apiUrl}/gateway/devices/${TEXTBEE_CONFIG.deviceId}/send-sms`,
      {
        recipients: [formattedPhone],
        message: message
      },
      {
        headers: {
          'x-api-key': TEXTBEE_CONFIG.apiKey,
          'Content-Type': 'application/json'
        },
        timeout: 30000 // 30 second timeout
      }
    );
    
    console.log('‚úÖ TextBee API response:', JSON.stringify(response.data, null, 2));
    
    // TextBee response structure check
    // Check multiple possible success indicators
    if (response.data) {
      // TextBee might return: { success: true, messageId: "..." }
      // OR: { status: "success", ... }
      // OR: { data: { success: true } }
      
      const isSuccess = 
        response.data.success === true ||
        response.data.status === 'success' ||
        response.data.status === 'queued' ||
        (response.data.data && response.data.data.success === true) ||
        response.status === 200; // If status code is 200, consider it success
      
      if (isSuccess) {
        console.log('‚úÖ SMS sent successfully!');
        return {
          success: true,
          messageId: response.data.messageId || response.data.id || 'textbee_' + Date.now(),
          provider: 'TextBee',
          recipient: formattedPhone
        };
      } else {
        console.error('‚ùå TextBee returned unsuccessful response:', response.data);
        throw new Error('SMS sending failed: ' + (response.data.error || response.data.message || 'Unknown error'));
      }
    } else {
      console.error('‚ùå Empty response from TextBee');
      throw new Error('SMS sending failed: Empty response from TextBee');
    }
    
  } catch (error) {
    console.error('‚ùå SMS sending error:', error);
    
    // Detailed error logging
    if (error.response) {
      console.error('   Response status:', error.response.status);
      console.error('   Response data:', error.response.data);
      console.error('   Response headers:', error.response.headers);
    }
    
    // Handle different types of errors
    if (error.code === 'ECONNABORTED') {
      throw new Error('SMS service timeout. Please try again.');
    } else if (error.code === 'ECONNREFUSED') {
      throw new Error('Cannot connect to TextBee service. Please check if your Android device is online and the TextBee app is running.');
    } else if (error.code === 'ENOTFOUND') {
      throw new Error('TextBee service not found. Please check your internet connection.');
    } else if (error.response) {
      // HTTP error response from TextBee
      const status = error.response.status;
      const data = error.response.data;
      
      if (status === 401) {
        throw new Error('Invalid TextBee API key. Please check your configuration.');
      } else if (status === 404) {
        throw new Error('TextBee device not found. Please check your Device ID.');
      } else if (status === 400) {
        const errorMsg = data?.error || data?.message || 'Invalid request';
        throw new Error(`TextBee error: ${errorMsg}`);
      } else {
        const errorMsg = data?.error || data?.message || status;
        throw new Error(`SMS service error: ${errorMsg}`);
      }
    } else if (error.message.includes('Network Error')) {
      throw new Error('Network error. Please check your internet connection.');
    } else {
      throw new Error(error.message || 'Failed to send SMS');
    }
  }
};

// Add this BEFORE the multer configuration (before line 495)

// Configure multer storage for file uploads
const storage = multer.diskStorage({
  destination: function (req, file, cb) {
    const uploadDir = path.join(__dirname, 'uploads', 'lab-results');
    // Ensure directory exists
    if (!fs.existsSync(uploadDir)) {
      fs.mkdirSync(uploadDir, { recursive: true });
    }
    cb(null, uploadDir);
  },
  filename: function (req, file, cb) {
    // Create unique filename with timestamp
    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
    cb(null, file.fieldname + '-' + uniqueSuffix + path.extname(file.originalname));
  }
});


add this in your backend .env:

TEXTBEE_API_KEY=600f06a4-bf17-4cce-9ce2-e365c2a0122d
TEXTBEE_DEVICE_ID=6922d84b82033f1609e3bbb6
