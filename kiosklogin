app.get('/api/admin/dashboard-stats', authenticateToken, async (req, res) => {
  try {
    if (req.user.type !== 'admin') {
      return res.status(403).json({ error: 'Access denied' });
    }

    const today = new Date().toISOString().split('T')[0];

    // Total Patients
    const { count: totalPatients } = await supabase
      .from('outpatient')
      .select('*', { count: 'exact', head: true });

    const { count: outPatientsToday } = await supabase
      .from('visit')
      .select('*', { count: 'exact', head: true })
      .eq('visit_date', today);

    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    const yesterdayStr = yesterday.toISOString().split('T')[0];

    const { count: yesterdayPatients } = await supabase
      .from('visit')
      .select('*', { count: 'exact', head: true })
      .eq('visit_date', yesterdayStr);

    let patientTrend = 0;
    if (yesterdayPatients === 0 && outPatientsToday > 0) {
      patientTrend = 100;
    } else if (yesterdayPatients > 0) {
      patientTrend = ((outPatientsToday - yesterdayPatients) / yesterdayPatients * 100).toFixed(1);
    }

    // Active Consultants (Online)
    const { count: activeConsultants } = await supabase
      .from('staff')
      .select('*', { count: 'exact', head: true })
      .eq('role', 'Doctor')
      .eq('is_online', true);

    // Appointments Today
    const { count: appointmentsToday } = await supabase
      .from('pre_registration')
      .select('*', { count: 'exact', head: true })
      .eq('scheduled_date', today)
      .in('status', ['pending', 'completed']);

    // Top 3 Health Trends (most common symptoms today)
    const { data: symptomsData } = await supabase
      .from('visit')
      .select('symptoms')
      .eq('visit_date', today);

    const symptomCounts = {};
    symptomsData?.forEach(visit => {
      if (visit.symptoms) {
        const symptomList = visit.symptoms.split(', ');
        symptomList.forEach(symptom => {
          symptomCounts[symptom] = (symptomCounts[symptom] || 0) + 1;
        });
      }
    });

    const topSymptoms = Object.entries(symptomCounts)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 3)
      .map(([name, count]) => ({ name, count }));

    // System Alerts (departments with long queues)
    const { data: queueData } = await supabase
      .from('queue')
      .select(`
        department_id,
        status,
        department!inner(name),
        visit!inner(visit_date)
      `)
      .eq('status', 'waiting')
      .eq('visit.visit_date', today);

    const departmentQueues = {};
    queueData?.forEach(item => {
      const deptName = item.department.name;
      departmentQueues[deptName] = (departmentQueues[deptName] || 0) + 1;
    });

    const alerts = Object.entries(departmentQueues)
      .filter(([_, count]) => count > 10)
      .map(([department, count]) => ({ department, count }));

    // Patient Flow Statistics
    const { data: flowData } = await supabase
      .from('queue')
      .select(`
        status,
        department_id,
        created_time,
        visit!inner(visit_date)
      `)
      .eq('visit.visit_date', today);

    const flowStats = {
      registration: flowData?.filter(q => q.status === 'waiting').length || 0,
      consultation: flowData?.filter(q => q.status === 'in_progress').length || 0,
      completed: flowData?.filter(q => q.status === 'completed').length || 0
    };

    // Calculate average wait time
    const waitTimes = flowData?.map(q => {
      const created = new Date(q.created_time);
      const now = new Date();
      return Math.floor((now - created) / (1000 * 60)); // minutes
    }) || [];
    const avgWaitTime = waitTimes.length > 0 
      ? Math.floor(waitTimes.reduce((a, b) => a + b, 0) / waitTimes.length) 
      : 0;

    // MODIFY THE RESPONSE TO INCLUDE TRENDS
    res.status(200).json({
      success: true,
      stats: {
        totalRegisteredPatients: totalPatients || 0,
        outPatientToday: outPatientsToday || 0,
        activeConsultants: activeConsultants || 0,
        appointmentsToday: appointmentsToday || 0
      },
      trends: {
        patients: parseFloat(patientTrend),  // Make sure it's a number
        yesterdayCount: yesterdayPatients || 0,
        todayCount: outPatientsToday || 0
      },
      topHealthTrends: topSymptoms,
      systemAlerts: alerts,
      patientFlow: flowStats,
      averageWaitTime: avgWaitTime
    });

  } catch (error) {
    console.error('Admin dashboard stats error:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
});
