-- No. 1
-- after ng const path = require('path');

-- insert 
const printServer = require('./printServer');

===================================================
-- No. 2
-- after ng require('dotenv').config();

-- insert
(async () => {
  try {
    await printServer.initialize();
    console.log('‚úÖ Print server initialized successfully');
  } catch (error) {
    console.error('‚ö†Ô∏è Print server initialization failed:', error);
    console.log('‚ÑπÔ∏è Printing features will be limited');
  }
})();

====================================================
-- No. 3
-- after ng

const authenticateToken = (req, res, next) => {
  const authHeader = req.headers['authorization'];
  const token = authHeader && authHeader.split(' ')[1];

  if (!token) {
    return res.status(401).json({ error: 'Access token required' });
  }

  jwt.verify(token, JWT_SECRET, (err, user) => {
    if (err) {
      return res.status(403).json({ error: 'Invalid or expired token' });
    }
    req.user = user;
    next();
  });
};

-- insert

app.get('/api/print/printers', async (req, res) => {
  try {
    const printers = await printServer.getAvailablePrinters();
    res.json({
      success: true,
      printers: printers
    });
  } catch (error) {
    console.error('Failed to get printers:', error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// Print patient guidance packet
app.post('/api/print/guidance', async (req, res) => {
  try {
    const { 
      registrationData, 
      patientData, 
      navigationSteps, 
      floorPlanImage,
      printerName 
    } = req.body;

    console.log('üñ®Ô∏è Print request received for patient:', registrationData.patientId);

    // Validate required data
    if (!registrationData || !patientData) {
      return res.status(400).json({
        success: false,
        error: 'Missing required patient data'
      });
    }

    // Print the document
    const result = await printServer.printPatientGuidance(
      registrationData,
      patientData,
      navigationSteps || [],
      floorPlanImage || null
    );

    if (result.success) {
      console.log('‚úÖ Print job completed successfully');
      res.json({
        success: true,
        message: 'Document sent to printer successfully'
      });
    } else {
      console.error('‚ùå Print job failed:', result.error);
      res.status(500).json({
        success: false,
        error: result.error
      });
    }

  } catch (error) {
    console.error('‚ùå Print endpoint error:', error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// Print thermal receipt
app.post('/api/print/receipt', async (req, res) => {
  try {
    const { registrationData, patientData } = req.body;

    console.log('üñ®Ô∏è Receipt print request for:', registrationData.patientId);

    // Generate simple receipt HTML
    const receiptHTML = `
      <!DOCTYPE html>
      <html>
      <head>
        <style>
          body {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            width: 80mm;
            margin: 0;
            padding: 10mm;
          }
          .center { text-align: center; }
          .bold { font-weight: bold; }
          .line { border-top: 1px dashed #000; margin: 5mm 0; }
        </style>
      </head>
      <body>
        <div class="center bold">CLICARE HOSPITAL</div>
        <div class="center">Patient Registration Receipt</div>
        <div class="line"></div>
        <div class="bold">PATIENT ID: ${registrationData.patientId}</div>
        <div>Name: ${patientData.fullName || patientData.name}</div>
        <div>Age/Sex: ${patientData.age} / ${patientData.sex}</div>
        <div class="line"></div>
        <div class="bold">DEPARTMENT: ${registrationData.recommendedDepartment}</div>
        <div class="bold">QUEUE NO: ${registrationData.queue_number || 'N/A'}</div>
        <div class="line"></div>
        <div><strong>SYMPTOMS:</strong></div>
        <div>${(patientData.selectedSymptoms || []).join(', ')}</div>
        <div class="line"></div>
        <div><strong>NEXT STEPS:</strong></div>
        <div>1. Go to Reception Desk</div>
        <div>2. Present this receipt</div>
        <div>3. Proceed to ${registrationData.recommendedDepartment}</div>
        <div>4. Wait for queue number</div>
        <div class="line"></div>
        <div class="center">Visit: ${new Date().toLocaleString()}</div>
        <div class="line"></div>
        <div class="center">Keep this receipt for your visit</div>
      </body>
      </html>
    `;

    // Create PDF and print
    const timestamp = Date.now();
    const pdfPath = path.join(__dirname, 'temp', `receipt_${timestamp}.pdf`);
    
    await printServer.generatePDF(receiptHTML, pdfPath);
    await printServer.printPDF(pdfPath);

    res.json({
      success: true,
      message: 'Receipt printed successfully'
    });

  } catch (error) {
    console.error('‚ùå Receipt print error:', error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// Test print endpoint (for debugging)
app.post('/api/print/test', async (req, res) => {
  try {
    const testHTML = `
      <!DOCTYPE html>
      <html>
      <head>
        <style>
          body { font-family: Arial; padding: 20px; }
          h1 { color: #1a672a; }
        </style>
      </head>
      <body>
        <h1>CliCare Hospital - Test Print</h1>
        <p>This is a test print from the CliCare print server.</p>
        <p>Date: ${new Date().toLocaleString()}</p>
        <p>If you can see this, the print server is working correctly!</p>
      </body>
      </html>
    `;

    const timestamp = Date.now();
    const pdfPath = path.join(__dirname, 'temp', `test_${timestamp}.pdf`);
    
    await printServer.generatePDF(testHTML, pdfPath);
    await printServer.printPDF(pdfPath);

    res.json({
      success: true,
      message: 'Test print sent successfully'
    });

  } catch (error) {
    console.error('‚ùå Test print error:', error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

=========================================
-- No. 4
-- after ng

app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
  console.log(`Email OTP: ${emailConfig.auth.user ? 'Configured' : 'Not configured'}`);
  console.log(`SMS OTP: ${isSMSConfigured ? 'iTexMo configured' : 'Not configured'}`);
  console.log(`Database: ${SUPABASE_URL ? 'Connected' : 'Not connected'}`);
});

-- insert 

process.on('SIGINT', async () => {
  await printServer.cleanup();
  process.exit(0);
});

process.on('SIGINT', async () => {
  console.log('\nüõë Shutting down print server...');
  await printServer.cleanup();
  process.exit(0);
});

process.on('SIGTERM', async () => {
  console.log('\nüõë Shutting down print server...');
  await printServer.cleanup();
  process.exit(0);
});
